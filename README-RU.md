# WayBack File Fetcher
Инструмент командной строки для поиска и загрузки файлов из архива WayBack Machine. 

[English version of README](https://github.com/CyberFazaN/wayback-fetcher/blob/main/README.md)

# Описание

WayBack File Fetcher — это утилита командной строки для поиска и загрузки файлов и индексов из архива WayBack Machine для заданного домена с гибкими параметрами фильтрации.  

## Особенности

- Получение и сохранение индексов архива для выбранного домена с помощью WayBack Machine CDX API.
- Фильтрация результатов по расширению файла, MIME-типу, статусу HTTP и/или регулярному выражению.
- Загрузка первой, последней и/или текущей (активной) версии каждого файла.
- Сохранение метаданных в форматах CSV и/или JSON и сохранение загруженных файлов в структурированном виде.
- Многопоточная загрузка (настраиваемое количество потоков).
- Поддержка локализации (английский и русский языки).

## Установка

### Poetry

1. **Клонируйте репозиторий:**

   ```bash
   git clone https://github.com/CyberFazaN/wayback-fetcher.git
   cd wayback-fetcher
   ```

2. **Создайте виртуальную среду и установите зависимости:**

   ```bash
   poetry install
   ```

3. **(Необязательно) Активируйте виртуальную среду:**

   ```bash
   poetry env activate
   ```

### Использование CLI

Убедитесь, что ваш `pyproject.toml` содержит следующий раздел для регистрации CLI-команды:
```toml
[tool.poetry.scripts]
wayback-fetcher = "wayback_fetcher:main"
```

Затем вы можете запустить скрипт следующим образом:
```bash
poetry run wayback-fetcher [аргументы]
```

### Запуск вне среды Poetry

Этот скрипт должен работать корректно с **Python 3.8 или выше** (тестировалось на Python 3.13+) и требует установки модуля `httpx` в вашей среде.

Вы можете запустить скрипт напрямую следующим образом:

```bash
python wayback_fetcher.py [аргументы]
# Или напрямую
./wayback_fetcher.py [аргументы]
```

Если вы установили зависимости с помощью Poetry, вы также можете вызвать скрипт с помощью интерпретатора Python из виртуальной среды,  созданной Poetry:

```bash
/path/to/wayback_fetcher_directory/.venv/bin/python /path/to/wayback_fetcher_directory/wayback_fetcher.py [аргументы]
```



## Быстрый старт

```bash
poetry run wayback-fetcher example.com -e pdf,jpg --download-firstlast --threads 4
```

## Аргументы командной строки

| Аргумент                             | Длинный/Тип                    | Описание                                                     |
| ------------------------------------ | ------------------------------ | ------------------------------------------------------------ |
| `domain`                             | str                            | Целевой домен (например, `example.com`).                     |
| `-l`, `--limit`                      | int (по умолчанию: 150000)     | Максимальное количество записей, которые нужно получить из API WayBack Machine. |
| `-http`, `--http`                    | (флаг)                         | Использовать HTTP вместо HTTPS для запросов архива.          |
| `-o`, `--output-folder`              | str                            | Каталог для сохранения результатов. По умолчанию: `output/<domain>_<date>`. |
| `-of`, `--output-format`             | csv, json, both (по умолчанию) | Формат вывода для файлов метаданных (`both` для выбора обеих). |
| `-v`, `--verbose`                    | (флаг)                         | Включить подробный (DEBUG) вывод.                            |
| **Фильтрация:**                      |                                |                                                              |
| `-e`, `--extensions`                 | str                            | Разделенный запятыми список расширений файлов (например, `.pdf,.jpg` или `pdf,jpg`). |
| `-m`, `--mimetypes`                  | str                            | Разделенный запятыми список MIME-типов файлов.               |
| `-r`, `--regex`                      | str                            | Регулярное выражение для фильтрации файлов по их URL-путям.  |
| `-sc`, `--statuscodes`               | str (по умолчанию: 200)        | Разделенный запятыми список кодов состояния HTTP для фильтрации архива. |
| **Параметры загрузки:**              |                                |                                                              |
| `-dw`, `--download`                  | (флаг)                         | Загрузить все соответствующие файлы (псевдоним для `-dfl -dc`). |
| `-df`, `--download-first`            | (флаг)                         | Загрузить первую архивированную версию каждого файла.        |
| `-dl`, `--download-last`             | (флаг)                         | Загрузить последнюю архивированную версию каждого файла.     |
| `-dfl`, `--download-firstlast`       | (флаг)                         | Загрузить как первую, так и последнюю версии (избегает дубликатов). |
| `-dc`, `--download-current`          | (флаг)                         | Загрузить текущую версию файла с действующего сайта.         |
| `-s`, `--structured`                 | (флаг)                         | Сохранить файлы в структурированном (подобном сайту) дереве каталогов (по умолчанию: все файлы в одном каталоге). |
| `-t`, `--threads`                    | int (1–64, по умолчанию: 1)    | Количество потоков для загрузки.                             |
| `-dt`, `--download-timeout`          | int                            | Таймаут для всех загрузок (секунды, применяется как к архиву, так и к источнику). |
| `-dtw`, `--download-timeout-wayback` | int (по умолчанию: 120)        | Таймаут для загрузки из архива (в секундах).                 |
| `-dto`, `--download-timeout-origin`  | int (по умолчанию: 60)         | Таймаут для загрузки с исходного сайта (в секундах).         |
| `-dr`, `--download-retries`          | int (по умолчанию: 2)          | Количество попыток повторения неудачных загрузок.            |
| `-drd`, `--download-retries-delay`   | int (по умолчанию: 5)          | Задержка между попытками (секунды).                          |
| `-dd`, `--deduplicate`               | (флаг)                         | Найти и удалить дубликаты загруженных файлов (сохраняет самые последние копии). |
| **Локализация:**                     |                                |                                                              |
| `-ru`, `--russian`                   | (флаг)                         | Принудительный вывод интерфейса на русском языке.            |
| `-en`, `--english`                   | (флаг)                         | Принудительный вывод интерфейса на английском языке.         |

---

## Логика фильтрации

WayBack File Fetcher поддерживает несколько опций фильтрации, позволяющих сузить набор файлов, которые будут индексироваться и загружаться:

| `-sc`, `--statuscodes` | Разделенный запятыми список кодов состояния HTTP (по умолчанию: `200`). |
| ---------------------- | ------------------------------------------------------------ |
| `-e`, `--extensions`   | Список расширений файлов, разделенных запятыми (например, `.pdf,.jpg` или `pdf,jpg`). |
| `-m`, `--mimetypes`    | Разделенный запятыми список типов MIME файлов (например, `application/pdf,image/jpeg`). |
| `-r`, `--regex`        | Регулярное выражение для сопоставления с URL-путем файла.    |


Фильтр **statuscodes** **применяется первым** на этапе индексирования: только записи архива с кодом ответа,  соответствующим одному из указанных кодов статуса, рассматриваются для дальнейшей  обработки.

Запись проходит фильтрацию, если **ее код статуса соответствует** одному из указанных кодов **и** выполняется хотя бы одно из следующих условий:

- Расширение файла находится в списке разрешенных расширений; **или**
- MIME-тип файла соответствует одному из указанных типов; **или**
- URL-путь файла соответствует заданному регулярному выражению (выражение оценивается с помощью `re.search` на URL-адресе, например,  `https://example.com/test/files/mydoc.pdf` -> `/test/files/mydoc.pdf`).

В целом, общая логика фильтрации такова:

```python
status_code in allowed_status_codes
    and (
        file_extension in allowed_extensions
        or mime_type in allowed_mimetypes
        or regex matches url_path
    )
```

Если не указаны ни расширения, ни MIME-типы, ни фильтры регулярных выражений, файл `targets`, содержащий отфильтрованные результаты, **не** будет создан в выходном каталоге. Если включена любая опция загрузки, все записи, соответствующие фильтру кода статуса, будут рассматриваться как цели загрузки (после подтверждения пользователем).

## Примеры использования

**Загрузка всех файлов PDF и JPEG с сайта:**
```bash
poetry run wayback-fetcher example.com -e pdf,jpg --download-firstlast
```

**Загрузить только текущие (активные) файлы JS:**
```bash
poetry run wayback-fetcher example.com -e js --download-current
```

**Загрузить все файлы XML по MIME-типу, сохранить метаданные только в формате JSON:**
```bash
poetry run wayback-fetcher example.com -e "application/xml,text/xml" -of json --download
```

**Загрузить все файлы, соответствующие регулярному выражению `/backup/.*zip$`:**
```bash
poetry run wayback-fetcher example.com -r '/backup/.*zip$' --download
```

---

## Выходные файлы

- **full-index** — все записи, возвращенные API WayBack Machine (фильтрации по HTTP-кодам статуса).
- **targets** — только записи, соответствующие вашим фильтрам.
- **multiple-versions** — записи с двумя или более уникальными копиями файлов в архиве.
- **unsuccessful-downloads** — файлы, которые не удалось загрузить.
- **files** — папка с успешно загруженными файлами.

Результаты могут быть сохранены в формате CSV, JSON или в обоих форматах, как указано в `-of`.

---

## Локализация

Язык скрипта определяется локалью системы или может быть принудительно установлен с помощью `-ru` или `-en`.

---

## Лицензия

Лицензия MIT (см. LICENSE)

---

## Автор

FazaN — [https://t.me/CyberFazaN](https://t.me/CyberFazaN)
